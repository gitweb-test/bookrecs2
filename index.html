<script>
  async function findRecommendations() {
    const query = document.getElementById('bookInput').value.trim();
    const resultsDiv = document.getElementById('results');
    resultsDiv.innerHTML = 'Loading...';

    try {
      // Step 1: Search for the book
      const searchRes = await fetch(`https://openlibrary.org/search.json?title=${encodeURIComponent(query)}`);
      const searchData = await searchRes.json();

      if (!searchData.docs.length) {
        resultsDiv.innerHTML = 'No results found.';
        return;
      }

      // Step 2: Pick the first result
      const book = searchData.docs[0];
      const workKey = book.key; // e.g. "/works/OL123W"
      const fallbackSubjects = book.subject_facet;

      let subjects = [];

      try {
        // Step 3: Try to get subjects from work details
        const workRes = await fetch(`https://openlibrary.org${workKey}.json`);
        const workData = await workRes.json();
        subjects = workData.subjects || [];
      } catch (e) {
        console.warn('Failed to load work details, falling back to search subjects');
      }

      if (subjects.length === 0 && fallbackSubjects) {
        subjects = fallbackSubjects;
      }

      if (!subjects || subjects.length === 0) {
        resultsDiv.innerHTML = 'No subjects found for this book.';
        return;
      }

      const mainSubject = encodeURIComponent(subjects[0]);

      // Step 4: Get books in same subject
      const subjectRes = await fetch(`https://openlibrary.org/subjects/${mainSubject}.json?limit=12`);
      const subjectData = await subjectRes.json();

      if (!subjectData.works || subjectData.works.length === 0) {
        resultsDiv.innerHTML = 'No recommendations found.';
        return;
      }

      // Step 5: Render recommendations
      resultsDiv.innerHTML = '';
      subjectData.works.forEach(book => {
        const coverId = book.cover_id;
        const coverUrl = coverId
          ? `https://covers.openlibrary.org/b/id/${coverId}-M.jpg`
          : 'https://via.placeholder.com/150x200?text=No+Cover';
        
        const bookDiv = document.createElement('div');
        bookDiv.className = 'book';
        bookDiv.innerHTML = `
          <img src="${coverUrl}" alt="${book.title}">
          <div><strong>${book.title}</strong></div>
          <div>${book.authors?.[0]?.name || ''}</div>
        `;
        resultsDiv.appendChild(bookDiv);
      });

    } catch (error) {
      console.error(error);
      resultsDiv.innerHTML = 'Something went wrong. Please try another title.';
    }
  }
</script>
